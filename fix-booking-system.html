<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„è®¢ç³»ç»Ÿä¿®å¤å·¥å…· - Patch Tattoo Therapy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .fix-container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .fix-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .fix-button { padding: 12px 24px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .fix-button:hover { background: #0056b3; }
        .success-button { background: #28a745; }
        .success-button:hover { background: #1e7e34; }
        .warning-button { background: #ffc107; color: #212529; }
        .warning-button:hover { background: #e0a800; }
        .danger-button { background: #dc3545; }
        .danger-button:hover { background: #c82333; }
        .info-box { background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .code-block { background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px; margin: 10px 0; }
        .status-success { color: #28a745; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
        .status-warning { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <div class="fix-container">
        <h1>ğŸ”§ é¢„è®¢ç³»ç»Ÿä¿®å¤å·¥å…·</h1>
        
        <div class="info-box">
            <h3>ğŸ“‹ ä¿®å¤ç›®æ ‡</h3>
            <p>è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š</p>
            <ul>
                <li>âŒ æ”¯ä»˜é¡µé¢æ˜¾ç¤º"æ”¯ä»˜è¡¨å•åŠ è½½å¤±è´¥"</li>
                <li>âŒ å’¨è¯¢é€‰æ‹©è·³è½¬åˆ°é”™è¯¯é¡µé¢</li>
                <li>âŒ Successé¡µé¢è·¯ç”±æ— æ³•è®¿é—®</li>
            </ul>
        </div>

        <div class="fix-section">
            <h3>ğŸ§¹ æ¸…ç†ç¼“å­˜å’Œæ•°æ®</h3>
            <button class="fix-button danger-button" onclick="clearAllData()">
                ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç¼“å­˜å’Œæ•°æ®
            </button>
            
            <button class="fix-button warning-button" onclick="clearLocalStorage()">
                ğŸ’¾ æ¸…é™¤localStorageæ•°æ®
            </button>
            
            <button class="fix-button" onclick="clearSessionStorage()">
                ğŸ“ æ¸…é™¤SessionStorage
            </button>
        </div>

        <div class="fix-section">
            <h3>ğŸ”„ é‡ç½®ç³»ç»ŸçŠ¶æ€</h3>
            <button class="fix-button" onclick="resetBookingState()">
                ğŸ”„ é‡ç½®é¢„è®¢çŠ¶æ€
            </button>
            
            <button class="fix-button" onclick="testSuccessRoute()">
                ğŸ¯ æµ‹è¯•Successé¡µé¢è·¯ç”±
            </button>
            
            <button class="fix-button" onclick="testPaymentFlow()">
                ğŸ’³ æµ‹è¯•æ”¯ä»˜æµç¨‹
            </button>
        </div>

        <div class="fix-section">
            <h3>ğŸŒ ç¯å¢ƒæ£€æµ‹</h3>
            <button class="fix-button" onclick="checkEnvironment()">
                ğŸ” æ£€æµ‹ç¯å¢ƒé…ç½®
            </button>
            
            <button class="fix-button" onclick="testNetworkConnectivity()">
                ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥
            </button>
        </div>

        <div class="fix-section">
            <h3>ğŸ“Š ä¿®å¤çŠ¶æ€</h3>
            <div id="fixStatus">
                <p>ä¿®å¤çŠ¶æ€å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>
            </div>
        </div>

        <div class="fix-section">
            <h3>ğŸ“‹ ä¿®å¤æ­¥éª¤</h3>
            <ol>
                <li><strong>æ¸…ç†ç¼“å­˜</strong> - ç‚¹å‡»"æ¸…é™¤æ‰€æœ‰ç¼“å­˜å’Œæ•°æ®"</li>
                <li><strong>é‡ç½®çŠ¶æ€</strong> - ç‚¹å‡»"é‡ç½®é¢„è®¢çŠ¶æ€"</li>
                <li><strong>æµ‹è¯•è·¯ç”±</strong> - ç‚¹å‡»"æµ‹è¯•Successé¡µé¢è·¯ç”±"</li>
                <li><strong>éªŒè¯æµç¨‹</strong> - é‡æ–°æµ‹è¯•å®Œæ•´é¢„è®¢æµç¨‹</li>
            </ol>
        </div>

        <div class="fix-section">
            <h3>ğŸ¯ éªŒè¯ä¿®å¤</h3>
            <button class="fix-button success-button" onclick="validateFix()">
                âœ… éªŒè¯ä¿®å¤ç»“æœ
            </button>
            
            <div id="validationResults">
                <p>éªŒè¯ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const statusElement = document.getElementById('fixStatus');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            statusElement.innerHTML += logEntry + '<br>';
            console.log(logEntry);
        }

        function clearAllData() {
            log('ğŸ§¹ å¼€å§‹æ¸…é™¤æ‰€æœ‰ç¼“å­˜å’Œæ•°æ®...');
            
            try {
                // æ¸…é™¤localStorage
                localStorage.clear();
                log('âœ… localStorageå·²æ¸…é™¤', 'success');
                
                // æ¸…é™¤sessionStorage
                sessionStorage.clear();
                log('âœ… sessionStorageå·²æ¸…é™¤', 'success');
                
                // æ¸…é™¤IndexedDBï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if ('indexedDB' in window) {
                    indexedDB.databases().then(databases => {
                        databases.forEach(db => {
                            indexedDB.deleteDatabase(db.name);
                        });
                        log('âœ… IndexedDBå·²æ¸…é™¤', 'success');
                    });
                }
                
                // æ¸…é™¤Service Workerç¼“å­˜
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(registrations => {
                        registrations.forEach(registration => {
                            registration.unregister();
                        });
                        log('âœ… Service Workerå·²æ¸…é™¤', 'success');
                    });
                }
                
                // æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆé€šè¿‡é‡æ–°åŠ è½½ï¼‰
                setTimeout(() => {
                    log('ğŸ”„ å³å°†é‡æ–°åŠ è½½é¡µé¢ä»¥æ¸…é™¤ç¼“å­˜...', 'warning');
                    window.location.reload(true);
                }, 2000);
                
            } catch (error) {
                log(`âŒ æ¸…é™¤æ•°æ®æ—¶å‡ºé”™: ${error.message}`, 'error');
            }
        }

        function clearLocalStorage() {
            log('ğŸ’¾ æ¸…é™¤localStorageæ•°æ®...');
            
            try {
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.includes('patch') || key.includes('booking') || key.includes('tattoo')) {
                        localStorage.removeItem(key);
                        log(`ğŸ—‘ï¸ å·²åˆ é™¤: ${key}`);
                    }
                });
                log('âœ… localStorageæ•°æ®å·²æ¸…é™¤', 'success');
            } catch (error) {
                log(`âŒ æ¸…é™¤localStorageå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearSessionStorage() {
            log('ğŸ“ æ¸…é™¤SessionStorage...');
            
            try {
                sessionStorage.clear();
                log('âœ… SessionStorageå·²æ¸…é™¤', 'success');
            } catch (error) {
                log(`âŒ æ¸…é™¤SessionStorageå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function resetBookingState() {
            log('ğŸ”„ é‡ç½®é¢„è®¢çŠ¶æ€...');
            
            try {
                // æ¸…é™¤é¢„è®¢ç›¸å…³æ•°æ®
                localStorage.removeItem('patchTattooBooking');
                localStorage.removeItem('currentStep');
                localStorage.removeItem('formData');
                localStorage.removeItem('selectedArtist');
                
                log('âœ… é¢„è®¢çŠ¶æ€å·²é‡ç½®', 'success');
                
                // è·³è½¬åˆ°é¦–é¡µé‡æ–°å¼€å§‹
                setTimeout(() => {
                    log('ğŸ”„ è·³è½¬åˆ°é¦–é¡µé‡æ–°å¼€å§‹...', 'warning');
                    window.location.href = '/';
                }, 1000);
                
            } catch (error) {
                log(`âŒ é‡ç½®é¢„è®¢çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testSuccessRoute() {
            log('ğŸ¯ æµ‹è¯•Successé¡µé¢è·¯ç”±...');
            
            // åˆ›å»ºæµ‹è¯•æ•°æ®
            const testData = {
                formData: {
                    name: 'Test User',
                    email: 'test@example.com',
                    tattooIdea: 'Test tattoo'
                },
                selectedArtist: {
                    displayName: 'Jing',
                    name: 'Jingxi Gu'
                },
                depositAmount: 300,
                timestamp: new Date().toISOString()
            };
            
            // ä¿å­˜æµ‹è¯•æ•°æ®
            localStorage.setItem('patchTattooBooking', JSON.stringify(testData));
            log('âœ… æµ‹è¯•æ•°æ®å·²ä¿å­˜', 'success');
            
            // æµ‹è¯•è·¯ç”±
            setTimeout(() => {
                log('ğŸ”— è·³è½¬åˆ° /success é¡µé¢...', 'warning');
                window.location.href = '/success';
            }, 1000);
        }

        function testPaymentFlow() {
            log('ğŸ’³ æµ‹è¯•æ”¯ä»˜æµç¨‹...');
            
            // åˆ›å»ºå®Œæ•´çš„æµ‹è¯•æ•°æ®
            const testData = {
                formData: {
                    artistId: 'jing',
                    name: 'Payment Test User',
                    email: 'payment-test@example.com',
                    phone: '(555) 123-4567',
                    tattooIdea: 'Payment test tattoo',
                    placement: 'Right forearm',
                    colorPreference: 'Black and gray',
                    needsConsultation: false
                },
                selectedArtist: {
                    id: 'jing',
                    name: 'Jingxi Gu',
                    displayName: 'Jing',
                    category: 'Lead Artist',
                    deposit: 300
                },
                consultationChoice: false,
                timestamp: new Date().toISOString(),
                depositAmount: 300,
                status: 'PENDING_PAYMENT'
            };
            
            // ä¿å­˜æµ‹è¯•æ•°æ®
            localStorage.setItem('patchTattooBooking', JSON.stringify(testData));
            log('âœ… æ”¯ä»˜æµ‹è¯•æ•°æ®å·²ä¿å­˜', 'success');
            
            // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
            setTimeout(() => {
                log('ğŸ”— è·³è½¬åˆ°æ”¯ä»˜é¡µé¢...', 'warning');
                window.location.href = '/';
            }, 1000);
        }

        function checkEnvironment() {
            log('ğŸ” æ£€æµ‹ç¯å¢ƒé…ç½®...');
            
            const envInfo = {
                hostname: window.location.hostname,
                protocol: window.location.protocol,
                port: window.location.port,
                userAgent: navigator.userAgent,
                localStorage: typeof(Storage) !== "undefined",
                sessionStorage: typeof(Storage) !== "undefined",
                indexedDB: 'indexedDB' in window,
                serviceWorker: 'serviceWorker' in navigator
            };
            
            log(`ğŸŒ ç¯å¢ƒä¿¡æ¯:`, 'info');
            log(`- Hostname: ${envInfo.hostname}`, 'info');
            log(`- Protocol: ${envInfo.protocol}`, 'info');
            log(`- Port: ${envInfo.port || 'default'}`, 'info');
            log(`- localStorage: ${envInfo.localStorage ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}`, envInfo.localStorage ? 'success' : 'error');
            log(`- sessionStorage: ${envInfo.sessionStorage ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}`, envInfo.sessionStorage ? 'success' : 'error');
            log(`- IndexedDB: ${envInfo.indexedDB ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}`, envInfo.indexedDB ? 'success' : 'error');
            log(`- Service Worker: ${envInfo.serviceWorker ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}`, envInfo.serviceWorker ? 'success' : 'error');
        }

        function testNetworkConnectivity() {
            log('ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥...');
            
            // æµ‹è¯•å¤šä¸ªç«¯ç‚¹
            const testUrls = [
                '/',
                '/success',
                'https://api.stripe.com',
                'https://api.emailjs.com'
            ];
            
            testUrls.forEach(url => {
                fetch(url, { method: 'HEAD' })
                    .then(response => {
                        log(`${url}: âœ… è¿æ¥æ­£å¸¸ (${response.status})`, 'success');
                    })
                    .catch(error => {
                        log(`${url}: âŒ è¿æ¥å¤±è´¥ - ${error.message}`, 'error');
                    });
            });
        }

        function validateFix() {
            log('âœ… å¼€å§‹éªŒè¯ä¿®å¤ç»“æœ...');
            
            const validationElement = document.getElementById('validationResults');
            let validation = '<strong>ğŸ” ä¿®å¤éªŒè¯ç»“æœ:</strong><br><br>';
            
            // æ£€æŸ¥localStorage
            const hasBookingData = localStorage.getItem('patchTattooBooking');
            validation += hasBookingData ? 'âœ… localStorageæ•°æ®æ­£å¸¸<br>' : 'âŒ localStorageæ•°æ®ç¼ºå¤±<br>';
            
            // æ£€æŸ¥è·¯ç”±æ”¯æŒ
            const hasHistory = 'pushState' in window.history;
            validation += hasHistory ? 'âœ… History APIæ”¯æŒ<br>' : 'âŒ History APIä¸æ”¯æŒ<br>';
            
            // æ£€æŸ¥ç¯å¢ƒ
            const isProduction = window.location.hostname === 'booking.patchtattootherapy.com';
            validation += isProduction ? 'âœ… ç”Ÿäº§ç¯å¢ƒæ£€æµ‹<br>' : 'âš ï¸ éç”Ÿäº§ç¯å¢ƒ<br>';
            
            // æ£€æŸ¥åè®®
            const isHttps = window.location.protocol === 'https:';
            validation += isHttps ? 'âœ… HTTPSåè®®<br>' : 'âŒ éHTTPSåè®®<br>';
            
            validation += '<br><strong>å»ºè®®æ“ä½œ:</strong><br>';
            if (!hasBookingData) {
                validation += '1. é‡æ–°å®Œæˆé¢„è®¢æµç¨‹<br>';
            }
            if (!isHttps && isProduction) {
                validation += '2. ç¡®ä¿ä½¿ç”¨HTTPSåè®®<br>';
            }
            validation += '3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜<br>';
            validation += '4. é‡æ–°æµ‹è¯•å®Œæ•´æµç¨‹<br>';
            
            validationElement.innerHTML = validation;
            log('âœ… éªŒè¯å®Œæˆ', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        window.onload = function() {
            log('ğŸš€ ä¿®å¤å·¥å…·åŠ è½½å®Œæˆ');
            checkEnvironment();
        };
    </script>
</body>
</html>
