<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe链接调试 - Patch Tattoo Therapy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .debug-container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .debug-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .debug-button { padding: 12px 24px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .debug-button:hover { background: #0056b3; }
        .success-button { background: #28a745; }
        .success-button:hover { background: #1e7e34; }
        .warning-button { background: #ffc107; color: #212529; }
        .warning-button:hover { background: #e0a800; }
        .danger-button { background: #dc3545; }
        .danger-button:hover { background: #c82333; }
        .info-box { background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .code-block { background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px; margin: 10px 0; }
        .status-success { color: #28a745; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
        .status-warning { color: #ffc107; font-weight: bold; }
        .link-display { word-break: break-all; }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>🔧 Stripe链接调试工具</h1>
        
        <div class="info-box">
            <h3>📋 调试目标</h3>
            <p>检查Stripe Payment Links配置，找出"live mode"错误的原因。</p>
        </div>

        <div class="debug-section">
            <h3>🌐 环境检测</h3>
            <div id="environmentInfo">
                <p>正在检测环境信息...</p>
            </div>
        </div>

        <div class="debug-section">
            <h3>🔗 链接测试</h3>
            <button class="debug-button" onclick="testAllLinks()">
                🧪 测试所有Payment Links
            </button>
            
            <button class="debug-button" onclick="testSpecificArtist('jing')">
                💳 测试Jing ($300)
            </button>
            
            <button class="debug-button" onclick="testSpecificArtist('jasmine')">
                💳 测试Jasmine ($100)
            </button>
            
            <button class="debug-button" onclick="testSpecificArtist('maili')">
                💳 测试Maili ($50)
            </button>
        </div>

        <div class="debug-section">
            <h3>📊 测试结果</h3>
            <div id="testResults">
                <p>测试结果将在这里显示...</p>
            </div>
        </div>

        <div class="debug-section">
            <h3>🔍 链接分析</h3>
            <div id="linkAnalysis">
                <p>链接分析结果将在这里显示...</p>
            </div>
        </div>

        <div class="debug-section">
            <h3>🛠️ 修复建议</h3>
            <div id="fixSuggestions">
                <p>修复建议将在这里显示...</p>
            </div>
        </div>
    </div>

    <script>
        // 模拟Stripe配置
        const FORCE_TEST_MODE = true;
        
        const STRIPE_PAYMENT_LINKS = {
            'jing': 'https://buy.stripe.com/00w6oHgLY6Zf5WW45Gfw400',
            'rachel': 'https://buy.stripe.com/3cIeVd8fsabr0CC31Cfw401',
            'jasmine': 'https://buy.stripe.com/3cIeVd8fsabr0CC31Cfw401',
            'lauren': 'https://buy.stripe.com/3cIeVd8fsabr0CC31Cfw401',
            'annika': 'https://buy.stripe.com/3cIeVd8fsabr0CC31Cfw401',
            'maili': 'https://buy.stripe.com/00w5kD9jwerH9988lWfw402',
            'keani': 'https://buy.stripe.com/00w5kD9jwerH9988lWfw402'
        };

        const STRIPE_TEST_PAYMENT_LINKS = {
            'jing': 'https://buy.stripe.com/test_00w6oHgLY6Zf5WW45Gfw400',
            'rachel': 'https://buy.stripe.com/test_3cIeVd8fsabr0CC31Cfw401',
            'jasmine': 'https://buy.stripe.com/test_3cIeVd8fsabr0CC31Cfw401',
            'lauren': 'https://buy.stripe.com/test_3cIeVd8fsabr0CC31Cfw401',
            'annika': 'https://buy.stripe.com/test_3cIeVd8fsabr0CC31Cfw401',
            'maili': 'https://buy.stripe.com/test_00w5kD9jwerH9988lWfw402',
            'keani': 'https://buy.stripe.com/test_00w5kD9jwerH9988lWfw402'
        };

        function log(message, type = 'info') {
            const resultsElement = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            resultsElement.innerHTML += logEntry + '<br>';
            console.log(logEntry);
        }

        function updateEnvironmentInfo() {
            const envElement = document.getElementById('environmentInfo');
            const info = {
                hostname: window.location.hostname,
                protocol: window.location.protocol,
                port: window.location.port,
                href: window.location.href,
                isLocalhost: window.location.hostname === 'localhost' || 
                             window.location.hostname.includes('127.0.0.1'),
                forceTestMode: FORCE_TEST_MODE
            };
            
            const isTestMode = FORCE_TEST_MODE || info.isLocalhost;
            
            envElement.innerHTML = `
                <div class="code-block">
                    <strong>环境信息:</strong><br>
                    Hostname: ${info.hostname}<br>
                    Protocol: ${info.protocol}<br>
                    Port: ${info.port || 'default'}<br>
                    Full URL: ${info.href}<br>
                    Is Localhost: ${info.isLocalhost ? '✅ 是' : '❌ 否'}<br>
                    Force Test Mode: ${info.forceTestMode ? '✅ 是' : '❌ 否'}<br>
                    <strong>最终模式: ${isTestMode ? '🧪 测试模式' : '🚀 生产模式'}</strong>
                </div>
            `;
        }

        function getStripePaymentLink(artistId) {
            const isTestMode = FORCE_TEST_MODE || 
                               window.location.hostname === 'localhost' || 
                               window.location.hostname.includes('127.0.0.1') || 
                               window.location.hostname.includes('localhost');
            
            console.log('🔍 Stripe环境检测:', {
                hostname: window.location.hostname,
                isTestMode: isTestMode,
                forceTestMode: FORCE_TEST_MODE,
                artistId: artistId
            });
            
            if (isTestMode) {
                const testLink = STRIPE_TEST_PAYMENT_LINKS[artistId] || STRIPE_TEST_PAYMENT_LINKS.rachel;
                console.log('🧪 使用测试环境链接:', testLink);
                return testLink;
            } else {
                const prodLink = STRIPE_PAYMENT_LINKS[artistId] || STRIPE_PAYMENT_LINKS.rachel;
                console.log('🚀 使用生产环境链接:', prodLink);
                return prodLink;
            }
        }

        function testAllLinks() {
            log('🧪 开始测试所有Payment Links...');
            
            const artists = ['jing', 'jasmine', 'maili'];
            
            artists.forEach(artist => {
                const link = getStripePaymentLink(artist);
                const isTestLink = link.includes('/test_');
                
                log(`${artist}: ${isTestLink ? '✅ 测试链接' : '❌ 生产链接'} - ${link}`, 
                    isTestLink ? 'success' : 'error');
            });
        }

        function testSpecificArtist(artistId) {
            log(`🧪 测试艺术家 ${artistId} 的Payment Link...`);
            
            const link = getStripePaymentLink(artistId);
            const isTestLink = link.includes('/test_');
            
            log(`艺术家: ${artistId}`, 'info');
            log(`链接: ${link}`, 'info');
            log(`类型: ${isTestLink ? '测试链接' : '生产链接'}`, isTestLink ? 'success' : 'error');
            
            // 分析链接
            analyzeLink(link, artistId);
        }

        function analyzeLink(link, artistId) {
            log('🔍 分析链接...');
            
            const analysisElement = document.getElementById('linkAnalysis');
            let analysis = `<strong>🔍 链接分析结果:</strong><br><br>`;
            
            // 检查是否是测试链接
            const isTestLink = link.includes('/test_');
            analysis += `链接类型: ${isTestLink ? '✅ 测试链接' : '❌ 生产链接'}<br>`;
            
            // 检查链接格式
            const hasStripeDomain = link.includes('buy.stripe.com');
            analysis += `Stripe域名: ${hasStripeDomain ? '✅ 正确' : '❌ 错误'}<br>`;
            
            // 检查艺术家ID
            const expectedAmount = artistId === 'jing' ? '$300' : 
                                  artistId === 'maili' ? '$50' : '$100';
            analysis += `预期金额: ${expectedAmount}<br>`;
            
            // 检查链接ID
            const linkId = link.split('/').pop();
            analysis += `链接ID: ${linkId}<br>`;
            
            // 建议
            if (!isTestLink) {
                analysis += `<br><strong>⚠️ 问题:</strong> 使用了生产链接，但应该使用测试链接<br>`;
                analysis += `<strong>🔧 解决方案:</strong> 检查FORCE_TEST_MODE设置或环境检测逻辑<br>`;
            } else {
                analysis += `<br><strong>✅ 状态:</strong> 链接配置正确<br>`;
            }
            
            analysisElement.innerHTML = analysis;
        }

        function generateFixSuggestions() {
            log('🛠️ 生成修复建议...');
            
            const suggestionsElement = document.getElementById('fixSuggestions');
            let suggestions = '<strong>🛠️ 修复建议:</strong><br><br>';
            
            // 检查当前配置
            const isTestMode = FORCE_TEST_MODE || 
                               window.location.hostname === 'localhost' || 
                               window.location.hostname.includes('127.0.0.1');
            
            if (!isTestMode) {
                suggestions += '<strong>❌ 问题:</strong> 当前不在测试模式<br>';
                suggestions += '<strong>🔧 解决方案:</strong><br>';
                suggestions += '1. 设置 FORCE_TEST_MODE = true<br>';
                suggestions += '2. 或在localhost环境下测试<br><br>';
            }
            
            suggestions += '<strong>📋 检查清单:</strong><br>';
            suggestions += '1. 确认FORCE_TEST_MODE = true<br>';
            suggestions += '2. 确认使用localhost环境<br>';
            suggestions += '3. 确认测试Payment Links正确配置<br>';
            suggestions += '4. 确认Stripe Dashboard中的链接是测试模式<br><br>';
            
            suggestions += '<strong>🎯 测试步骤:</strong><br>';
            suggestions += '1. 在localhost环境下测试<br>';
            suggestions += '2. 使用测试卡号: 4242 4242 4242 4242<br>';
            suggestions += '3. 检查浏览器控制台的环境检测日志<br>';
            
            suggestionsElement.innerHTML = suggestions;
        }

        // 页面加载时自动运行
        window.onload = function() {
            log('🚀 Stripe链接调试工具加载完成');
            updateEnvironmentInfo();
            generateFixSuggestions();
        };
    </script>
</body>
</html>
