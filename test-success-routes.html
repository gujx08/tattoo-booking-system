<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Success页面路由测试 - Patch Tattoo Therapy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .test-button { padding: 12px 24px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .test-button:hover { background: #0056b3; }
        .success-button { background: #28a745; }
        .success-button:hover { background: #1e7e34; }
        .warning-button { background: #ffc107; color: #212529; }
        .warning-button:hover { background: #e0a800; }
        .info-box { background: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .code-block { background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px; margin: 10px 0; }
        .status-success { color: #28a745; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
        .status-warning { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔧 Success页面路由测试</h1>
        
        <div class="info-box">
            <h3>📋 测试目标</h3>
            <p>验证Success页面可以通过URL直接访问，并且能够正确显示预订数据。</p>
        </div>

        <div class="test-section">
            <h3>🎯 路由测试</h3>
            <p>测试不同的路由访问方式：</p>
            
            <button class="test-button" onclick="testDirectSuccessAccess()">
                🔗 直接访问 /success
            </button>
            
            <button class="test-button" onclick="testWithMockData()">
                📝 模拟预订数据后访问
            </button>
            
            <button class="test-button" onclick="testStripeRedirect()">
                💳 模拟Stripe支付跳转
            </button>
            
            <button class="test-button warning-button" onclick="clearLocalStorage()">
                🗑️ 清除localStorage数据
            </button>
        </div>

        <div class="test-section">
            <h3>📊 当前状态</h3>
            <div id="currentStatus">
                <p>正在检查当前状态...</p>
            </div>
        </div>

        <div class="test-section">
            <h3>🔍 调试信息</h3>
            <div id="debugInfo">
                <p>调试信息将在这里显示...</p>
            </div>
        </div>

        <div class="test-section">
            <h3>📋 测试步骤</h3>
            <ol>
                <li><strong>清除数据</strong> - 点击"清除localStorage数据"按钮</li>
                <li><strong>直接访问</strong> - 点击"直接访问 /success"测试无数据情况</li>
                <li><strong>模拟数据</strong> - 点击"模拟预订数据后访问"测试有数据情况</li>
                <li><strong>验证功能</strong> - 确认Success页面能正确显示和发送邮件</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>🎯 期望结果</h3>
            <ul>
                <li>✅ 直接访问 `/success` 显示通用成功信息</li>
                <li>✅ 有预订数据时显示完整的预订摘要</li>
                <li>✅ 邮件发送功能正常工作</li>
                <li>✅ "Book Another Appointment" 按钮正确跳转</li>
            </ul>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const debugElement = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugElement.innerHTML += logEntry + '<br>';
            console.log(logEntry);
        }

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('currentStatus');
            const className = type === 'success' ? 'status-success' : 
                             type === 'error' ? 'status-error' : 
                             type === 'warning' ? 'status-warning' : '';
            
            statusElement.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function checkCurrentStatus() {
            log('检查当前状态...');
            
            const savedData = localStorage.getItem('patchTattooBooking');
            if (savedData) {
                try {
                    const bookingData = JSON.parse(savedData);
                    log('✅ 找到保存的预订数据', 'success');
                    log(`- 客户: ${bookingData.formData?.name || 'N/A'}`);
                    log(`- 艺术家: ${bookingData.selectedArtist?.displayName || 'N/A'}`);
                    log(`- 押金: $${bookingData.depositAmount || 'N/A'}`);
                    
                    updateStatus('✅ 找到预订数据，Success页面将显示完整信息', 'success');
                } catch (error) {
                    log('❌ 解析localStorage数据失败: ' + error.message, 'error');
                    updateStatus('❌ localStorage数据格式错误', 'error');
                }
            } else {
                log('⚠️ 没有找到预订数据', 'warning');
                updateStatus('⚠️ 没有预订数据，Success页面将显示通用信息', 'warning');
            }
        }

        function testDirectSuccessAccess() {
            log('🧪 测试直接访问 /success...');
            
            // 清除localStorage确保测试干净
            localStorage.removeItem('patchTattooBooking');
            log('🗑️ 已清除localStorage数据');
            
            // 跳转到success页面
            window.location.href = '/success';
        }

        function testWithMockData() {
            log('📝 创建模拟预订数据...');
            
            const mockBookingData = {
                formData: {
                    artistId: 'jing',
                    name: 'Test User',
                    email: 'test@example.com',
                    phone: '(555) 123-4567',
                    tattooIdea: 'A beautiful dragon tattoo',
                    referenceImages: ['ref1.jpg', 'ref2.jpg'],
                    additionalNotes: 'I want it colorful',
                    instagramReference: '@testuser',
                    backgroundStory: 'This represents my journey',
                    placement: 'Full sleeve on left arm',
                    bodyPhotos: ['photo1.jpg'],
                    placementCertainty: 'Very certain',
                    openToSuggestions: 'Yes, open to suggestions',
                    colorPreference: 'I like vibrant colors',
                    skinTone: 'Medium-Light',
                    isFirstTattoo: 'I have 1-2 small tattoos',
                    additionalInfo: 'I have sensitive skin',
                    needsConsultation: true
                },
                selectedArtist: {
                    id: 'jing',
                    name: 'Jingxi Gu',
                    displayName: 'Jing',
                    category: 'Lead Artist',
                    deposit: 300
                },
                consultationChoice: true,
                timestamp: new Date().toISOString(),
                depositAmount: 300,
                status: 'PENDING_PAYMENT'
            };

            // 保存到localStorage
            localStorage.setItem('patchTattooBooking', JSON.stringify(mockBookingData));
            log('✅ 模拟数据已保存到localStorage', 'success');
            
            // 跳转到success页面
            setTimeout(() => {
                log('🔗 跳转到 /success 页面...');
                window.location.href = '/success';
            }, 500);
        }

        function testStripeRedirect() {
            log('💳 模拟Stripe支付成功跳转...');
            
            // 创建模拟数据（模拟支付完成后的状态）
            const mockBookingData = {
                formData: {
                    artistId: 'jing',
                    name: 'Stripe Test User',
                    email: 'stripe-test@example.com',
                    phone: '(555) 987-6543',
                    tattooIdea: 'Stripe payment test tattoo',
                    placement: 'Right forearm',
                    colorPreference: 'Black and gray',
                    needsConsultation: false
                },
                selectedArtist: {
                    id: 'jing',
                    name: 'Jingxi Gu',
                    displayName: 'Jing',
                    category: 'Lead Artist',
                    deposit: 300
                },
                consultationChoice: false,
                timestamp: new Date().toISOString(),
                depositAmount: 300,
                status: 'PAYMENT_COMPLETED'
            };

            // 保存到localStorage
            localStorage.setItem('patchTattooBooking', JSON.stringify(mockBookingData));
            log('✅ Stripe支付模拟数据已保存', 'success');
            
            // 模拟URL参数（Stripe可能添加的参数）
            const successUrl = '/success?payment_intent=pi_test_123&redirect_status=succeeded';
            log(`🔗 跳转到: ${successUrl}`);
            
            setTimeout(() => {
                window.location.href = successUrl;
            }, 500);
        }

        function clearLocalStorage() {
            log('🗑️ 清除localStorage数据...');
            localStorage.removeItem('patchTattooBooking');
            log('✅ localStorage数据已清除', 'success');
            updateStatus('✅ localStorage数据已清除', 'success');
            
            // 刷新状态显示
            setTimeout(checkCurrentStatus, 100);
        }

        // 页面加载时检查状态
        window.onload = function() {
            log('🚀 路由测试页面加载完成');
            checkCurrentStatus();
        };
    </script>
</body>
</html>
